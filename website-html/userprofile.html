<!DOCTYPE HTML>
<html>
    <head>
        <title>User Profile</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
        <link rel="stylesheet" href="assets/css/main.css" />
        <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
        </head>
    <body class="landing2 is-preload">


        <!-- Page Wrapper -->
        <div id="page-wrapper">

            <!-- Header -->
            <header id="header" class="alt">

                <nav id="nav">

                    <ul class="menuToggle">
                        <a href="afterlogin.html" class="no-style more scrolly zero-text">Back to Homepage</a>
                        &nbsp;
                        |

                    </ul>

                </nav>
            </header>
            <div class="wrapper style3">

                    <h2 align="center">User Profile</h2>
                    <h6 align="center">This is your profile page. You can edit your major and <br/>add current classes you're taking
                        to customize your search.</h6><br/><br/>
                    <section>
                        <div class="card" style="width: 50rem;">
                            <div align="center">
                                <img id="profilePicUserProfile" src="images/gary.jpg" class="avatar" alt="avatar" >
                                <p id="welcomeMessage"></p>
                            </div>

                            <form id="profileForm">
                                <div class="row gtr-uniform">
                                    <div class="col-6 col-12-xsmall">
                                        <label>Email</label>
                                        <textarea placeholder="Email" rows="1" id="email" readonly></textarea>
                                    </div>
                                    <div class="col-6 col-12-xsmall">
                                        <label>Full Name</label>
                                        <textarea placeholder="Full Name" rows="1" id="fullname" readonly></textarea>
                                    </div>
                                    <div class="col-6">
                                        <label>Major</label>
                                        <input id="inputMajor" type="text" name="searchmajor" style="text-align:left; width: 760px;" placeholder="Search Major">
                                    </div>
                                </div>
                                <br/>
                                <!--adding classes-->
                                <div class="autocomplete" style="width: auto;">
                                    <label>Classes</label>
                                    <input id="inputClasses" type="text" name="searchclasses" style="text-align:left; width: 600px;" placeholder="Search Classes">
                                </div>
                                <input type="button" id = "btnAdd" value = "Add" onclick = "Add()" style="border: 1px solid #cccccc"/>
                                <textarea placeholder="Add Classes" rows="8" cols="100" id="courseListToSave" readonly></textarea>
                                <div align="center">
                                <input id="clear" type="button" value = "Clear" onclick="clearList()"  style="border: 1px solid #cccccc"></input>
                                <input id="save" type="button" value = "Save Changes" onclick="updateProfile()"  style="border: 1px solid #cccccc"></input>
                                </div>
                            </form>
                        </div>
                    </section>
            </div>


        <!-- Scripts -->
        <script src="assets/js/jquery.min.js"></script>
        <script src="assets/js/jquery.scrollex.min.js"></script>
        <script src="assets/js/jquery.scrolly.min.js"></script>
        <script src="assets/js/browser.min.js"></script>
        <script src="assets/js/breakpoints.min.js"></script>
        <script src="assets/js/util.js"></script>
        <script src="assets/js/main.js"></script>
        <script src="assets/js/login.js"></script>
        <script src="assets/js/searchClass.js"></script>
        <!--<script src="assets/js/searchCommunity.js"></script>-->


        <!-- below is firebase SDKs-->
        <!-- Add Firebase SDKs and initialize Firebase from HOSTING URL-->
        <!-- this works only when we are using firebase hosting service-->
        <!-- and it's userful because we don't have to initialize firebaseConfig manually-->
        <script src="/__/firebase/8.0.1/firebase-app.js"></script>
        <script src="/__/firebase/8.0.1/firebase-analytics.js"></script>
        <script src="/__/firebase/8.0.1/firebase-auth.js"></script>
        <script src="/__/firebase/8.0.1/firebase-database.js"></script>
        <script src="/__/firebase/init.js"></script>

        <!-- add courses to the textbox -->
        <script type="text/javascript">

            var courseArray = [];
            var courseCount = 0;

            window.onload = function() {
                // get all class info from FB databse
                //getCommunitySnapshot();
                getClassSnapshot();

                document.getElementById("email").placeholder=localStorage.getItem("user-email");
                document.getElementById("email").value=localStorage.getItem("user-email");
                // localStorage.removeItem("user-email");
                document.getElementById("fullname").placeholder=localStorage.getItem("user-displayname");
                document.getElementById("fullname").value=localStorage.getItem("user-displayname");
                // localStorage.removeItem("user-displayname");
                // take url of user's profile pic from login.js, get a resized version (unsure if always works)
                var profileImgUrl = localStorage.getItem("user-profileimgurl");
                profileImgUrl = profileImgUrl.replace("s96-c", "s512-c");
                document.getElementById("profilePicUserProfile").src=profileImgUrl;
                //remove local storage items in signout function for security.
                document.getElementById("welcomeMessage").innerHTML="Hi " + localStorage.getItem("user-displayname").substr(0,localStorage.getItem("user-displayname").indexOf(' ')) + "!";

                // load any db-saved courses to the page
                firebase.database().ref("userProfiles").child("a3ramos").child("courseList").on('value', function(dataSnapshot) {
                    // take DataSnapshot obj, which might be null
                    courseArray = dataSnapshot.val();
                    if (courseArray == null) {
                        //console.log(courseArray + " this is from db");
                        courseArray = [];
                        //console.log(courseArray + " this is empty arr");
                    } else if (typeof courseArray === "string"){
                        // take string of comma-seperated classes, turn into an array of strings
                        //console.log(courseArray + " this is from db");
                        courseArray = courseArray.split(",");
                        courseCount = courseArray.length;
                        //console.log(courseArray + " this is new arr");
                        if(courseArray[0].length === 0){
                            courseArray = [];
                            courseCount = 0;
                        }
                        // clear and fill in the course list textbox 
                        document.getElementById("courseListToSave").value = "";
                        for (i of courseArray) {
                            document.getElementById("courseListToSave").value = document.getElementById("courseListToSave").value + i + "\n";
                            //console.log(i);
                        }
                    }
                });
                
            }

            // currently only for dropdown in select, no duplicate add check 
            function Add() {
                var currentCourse = document.getElementById("inputClasses").value;
                //check if user input is valid
                if(classesArr.includes(currentCourse) && currentCourse !== ""){
                    //console.log("good add");
                }
                else{
                    alert("The class you entered is not in our Database.");
                    return false;
                }
                //console.log("Add " +  currentCourse);
                var i;
                for (i of courseArray) {
                    if(i == currentCourse){
                        alert("The class you entered is already in the list.");
                        return false;
                    }
                }
                courseArray[courseCount] = currentCourse;
                courseCount++;
                // clear and fill in the course list textbox 
                document.getElementById("courseListToSave").value = "";
                for (i of courseArray) {
                    document.getElementById("courseListToSave").value = document.getElementById("courseListToSave").value + i + "\n";
                    //console.log(i);
                }

            }

            function updateProfile(){
                //console.log("Save ");
                //console.log(courseArray.toString());

                var courses = courseArray.toString();
                // used username as key in order to avoid multiple entry from the same user
                var usernameKey = document.getElementById("email").value;
                // username is the email without @ucsd.edu
                usernameKey = usernameKey.substring(0, usernameKey.indexOf('@'));
                //console.log(usernameKey);

                // iterate through courseArray, send to firebase db
                firebase.database().ref("userProfiles").child(usernameKey).set({
                    email: document.getElementById("email").value,
                    fullname: document.getElementById("fullname").value,
                    major: document.getElementById("inputMajor").value,
                    courseList: courses, //document.getElementById("courseListToSave").value,
                });

                alert("Enrolled courses saved!")

            }
            // clear is not meant to update db, only the list visible on page
            function clearList(){
                //console.log("clear ");
                //console.log(courseArray.toString());

                document.getElementById("courseListToSave").value = "";
                courseArray = [];
                courseCount = 0;
            }
        </script>

        <!-- Footer -->
        <footer id="footer">
            <ul class="icons">
                <!-- <li><a href="#" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li> -->
                <li><a href="#" class="icon brands fa-facebook-f"><span class="label">Facebook</span></a></li>
                <li><a href="#" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li>
                <!-- <li><a href="#" class="icon brands fa-dribbble"><span class="label">Dribbble</span></a></li> -->
                <li><a href="#" class="icon solid fa-envelope"><span class="label">Email</span></a></li>
            </ul>
            <ul class="copyright"></br>
                <li>3855 Nobel Dr #1243, San Diego, CA 92122 |</li> </br>
                <li>(408) 533-5213 |</li> </br>
                <li>spryleaf@spryleaf.io |</li> </br>
            </ul>
        </footer>
    </body>
</html>